{"version":3,"sources":["page/sourcemap/component/Editor/index.js","page/sourcemap/component/ErrorTab/index.js","page/sourcemap/util/index.js","page/sourcemap/index.js","page/sourcemap/hook/useErrorListener.js"],"names":["Editor","content","startLine","endLine","editor","useRef","decorateAndScroll","setTimeout","deltaDecorations","range","monaco","Range","options","isWholeLine","className","revealLineInCenter","Math","ceil","useEffect","current","language","theme","value","readOnly","editorDidMount","e","memo","ErrorTab","name","desc","code","onTrigger","onAnalyze","onInputChange","errorInfo","errorResult","useState","index","setIndex","_onInputChange","target","id","_onCalculate","next","error","message","warning","lines","split","line","path","exec","url","lineNo","columnNo","length","layout","Item","label","type","onClick","bind","msg","disabled","onChange","TextArea","rows","analyzeSourcemap","a","getFileContentFromUrl","mapContent","Promise","res","sourceMap","SourceMapConsumer","with","consumer","position","originalPositionFor","Number","column","sourceContentFor","source","TabPane","Tabs","Sourcemap","console","log","tabConfigList","useSelector","state","sourcemap","dispatch","useDispatch","setError","window","onerror","err","stack","onunhandledrejection","reason","useErrorListener","Error","tabConfig","find","item","key","result","editConfigList","props","editConfigListErrorInfo","defaultActiveKey","map","tab"],"mappings":"wWAKA,SAASA,EAAT,GAAkD,IAAhCC,EAA+B,EAA/BA,QAASC,EAAsB,EAAtBA,UAAWC,EAAW,EAAXA,QAI9BC,EAASC,iBAAO,MAEtB,SAASC,EAAkBF,GACpBA,GAA+B,kBAAdF,GAA6C,kBAAZC,IAGnDD,EAAYC,GAGhBI,YAAW,WACTH,EAAOI,iBACL,GACA,CACE,CACEC,MAAO,IAAIC,IAAOC,MAAMT,EAAW,EAAGC,EAAS,GAC/CS,QAAS,CACPC,aAAa,EACbC,UAAW,yBAKnBV,EAAOW,mBAAmBC,KAAKC,MAAMf,EAAYC,GAAW,MAC3D,MAOL,OAJAe,qBAAU,WACRZ,EAAkBF,EAAOe,WACxB,CAAClB,EAASC,EAAWC,IAGtB,qBAAKW,UAAU,SAAf,SACE,cAAC,IAAD,CACEM,SAAS,aACTC,MAAM,KACNC,MAAOrB,EACPW,QAvCU,CACdW,UAAU,GAuCNC,eAAgB,SAACC,GACfrB,EAAOe,QAAUM,EACjBnB,EAAkBF,EAAOe,cAapBO,qBAAK1B,GCvDpB,SAAS2B,EAAT,GAA0H,IAAtGC,EAAqG,EAArGA,KAAMC,EAA+F,EAA/FA,KAAMC,EAAyF,EAAzFA,KAAM5B,EAAmF,EAAnFA,UAAWC,EAAwE,EAAxEA,QAAS4B,EAA+D,EAA/DA,UAAWC,EAAoD,EAApDA,UAAWC,EAAyC,EAAzCA,cAAeC,EAA0B,EAA1BA,UAAWC,EAAe,EAAfA,YACxG,EAA0BC,mBAAS,GAAnC,mBAAOC,EAAP,KAAcC,EAAd,KASA,SAASC,EAAed,GACtB,MAAsBA,EAAEe,OAAhBC,EAAR,EAAQA,GAAInB,EAAZ,EAAYA,MACa,oBAAlBW,GACLA,EAAcL,EAAD,eACVa,EAAKnB,IAGZ,SAASoB,EAAaC,GACpB,KAAI,OAACT,QAAD,IAACA,OAAD,EAACA,EAAWU,OACd,OAAOC,IAAQC,QAAQ,yCAEzB,IAAMC,EAAK,OAAGb,QAAH,IAAGA,OAAH,EAAGA,EAAWU,MAAMI,MAAM,MAC/BC,EAAOF,EAAMV,GAGba,EADS,6JACKC,KAAKF,GACzB,cAAoCC,EAApC,GAAWE,EAAX,KAAgBC,EAAhB,KAAwBC,EAAxB,KAmBA,OAlBAf,EAAe,CACbC,OAAQ,CACNC,GAAI,MACJnB,MAAO8B,KAGXb,EAAe,CACbC,OAAQ,CACNC,GAAI,SACJnB,MAAO+B,KAGXd,EAAe,CACbC,OAAQ,CACNC,GAAI,WACJnB,MAAOgC,KAGPX,GAAQN,GAASU,EAAMQ,OAAS,EAC3BV,IAAQC,QAAQ,sDACdH,GAAQN,GAAS,EACnBQ,IAAQC,QAAQ,oDAEzBR,EAASK,EAAON,EAAQ,EAAIA,EAAQ,GAGtC,OACE,sBAAKvB,UAAU,WAAf,UACE,eAAC,IAAD,CAAM0C,OAAO,WAAb,UACE,cAAC,IAAKC,KAAN,CAAWC,MAAM,2BAAjB,SAAyB7B,IACzB,cAAC,IAAK4B,KAAN,CAAWC,MAAM,2BAAjB,SACE,qBAAK5C,UAAU,iBAAf,SACE,cAAC,EAAD,CAAqBb,QAAS6B,EAAM5B,UAAWA,EAAWC,QAASA,GAAvD,iBAKlB,sBAAKW,UAAU,iBAAf,UACE,sBAAKA,UAAU,uBAAf,UACE,sBAAKA,UAAU,sBAAf,UACE,cAAC,IAAD,CAAQ6C,KAAK,UAAUC,QA/DjC,WACuB,oBAAd7B,GAA4BA,EAAUH,IA8DrC,sCAGA,cAAC,IAAD,CAAQ+B,KAAK,UAAUC,QAASlB,EAAamB,KAAK,MAAM,GAAxD,oEAGA,cAAC,IAAD,CAAQF,KAAK,UAAUC,QAASlB,EAAamB,KAAK,MAAM,GAAxD,uEAIF,sBAAK/C,UAAU,sBAAf,mDACWuB,KAEX,eAAC,IAAD,WACE,cAAC,IAAKoB,KAAN,CAAWC,MAAM,2BAAjB,SACE,cAAC,IAAD,CAAOpC,MAAOY,EAAU4B,IAAKC,UAAQ,MAEvC,cAAC,IAAKN,KAAN,CAAWC,MAAM,2BAAjB,SACE,cAAC,IAAD,CAAOpC,MAAOY,EAAUmB,OAAQW,SAAUzB,EAAgBE,GAAG,SAASsB,UAAQ,MAEhF,cAAC,IAAKN,KAAN,CAAWC,MAAM,2BAAjB,SACE,cAAC,IAAD,CAAOpC,MAAOY,EAAUoB,SAAUU,SAAUzB,EAAgBE,GAAG,WAAWsB,UAAQ,MAEpF,cAAC,IAAKN,KAAN,CAAWC,MAAM,2BAAjB,SACE,cAAC,IAAD,CAAOpC,MAAOY,EAAUkB,IAAKY,SAAUzB,EAAgBE,GAAG,MAAMsB,UAAQ,MAE1E,cAAC,IAAKN,KAAN,CAAWC,MAAM,2BAAjB,SACE,cAAC,IAAMO,SAAP,CAAgB3C,MAAOY,EAAUU,MAAOsB,KAAM,GAAIH,UAAQ,YAIhE,sBAAKjD,UAAU,wBAAf,UACE,qBAAKA,UAAU,sBAAf,SACE,cAAC,IAAD,CAAQ6C,KAAK,UAAUC,QA7FjC,WACuB,oBAAd5B,GAA4BA,EAAUJ,IA4FrC,sCAKF,qBAAKd,UAAU,yBAAf,SACE,cAAC,EAAD,CAAqBb,QAASkC,EAAYlC,QAASC,UAAWiC,EAAYc,KAAM9C,QAASgC,EAAYc,MAAzF,qBAqBTvB,qBAAKC,G,iCCnILwC,E,8EAAf,WAAgCvB,GAAhC,eAAAwB,EAAA,sEAC2BC,YAAsB,GAAD,OAAIzB,EAAMQ,IAAV,SADhD,cACQkB,EADR,yBAES,IAAIC,SAAQ,SAACC,GAClBC,UAAUC,kBAAkBC,KAAKL,EAAY,MAAM,SAACM,GAClD,IAAMC,EAAWD,EAASE,oBAAoB,CAC5C7B,KAAM8B,OAAOnC,EAAMS,QACnB2B,OAAQD,OAAOnC,EAAMU,YAEjBrD,EAAU2E,EAASK,iBAAiBJ,EAASK,QACnDV,EAAI,aACFvE,WACG4E,WAXX,4C,sBCOA,IAAQM,EAAYC,IAAZD,QA6EOE,UA3Ef,WACEC,QAAQC,IAAI,oBACZ,IAAMC,EAAgBC,aAAY,SAACC,GACjC,OAAOA,EAAMC,UAAUH,iBAEnBI,EAAWC,cACjB,ECda,WACb,MAA0BzD,mBAAS,IAAnC,mBAAOQ,EAAP,KAAckD,EAAd,KAwBA,OAvBA5E,qBAAU,WACR6E,OAAOC,QAAU,SAAUlC,EAAKV,EAAKC,EAAQC,EAAU2C,GASrD,OARAH,EAAS,CACPhC,MACAV,MACAC,SACAC,WACAV,MAAOqD,EAAIC,MACXtE,KAAMqE,EAAIpD,WAEL,GAETkD,OAAOI,qBAAuB,SAAS1E,GACrC,IAAM2E,EAAS3E,EAAE2E,OACjBN,EAAS,CACPhC,IAAKsC,EAAOvD,QACZO,IAAK,GACLC,OAAQ,GACRT,MAAOwD,EAAOF,MACdtE,KAAMwE,EAAOvD,aAGhB,IACI,CACLD,SDZgByD,GAAVzD,EAAR,EAAQA,MAcR,SAASb,EAAUH,GACjB,GAAa,WAATA,EACF,MAAM,IAAI0E,MAAM,UACE,WAAT1E,GACT,IAAI2C,SAAQ,WACV,MAAM,IAAI+B,MAAM,aAzBH,SA8BJtE,EA9BI,8EA8BnB,WAAyBJ,GAAzB,iBAAAwC,EAAA,6DACQmC,EAAYf,EAAcgB,MAAK,SAACC,GACpC,OAAOA,EAAKC,MAAQ9E,KAFxB,SAIuBuC,EAAiBoC,EAAUrE,WAJlD,OAIQyE,EAJR,OAKEf,EACEgB,YAAe,CACbF,IAAK9E,EACLiF,MAAO,CACL1E,YAAY,eACPwE,OAVb,4CA9BmB,sBA+CnB,SAAS1E,EAAcL,EAAMiF,GAC3BjB,EACEkB,YAAwB,CACtBJ,IAAK9D,EAAMhB,KACXiF,WAKN,OAjDA3F,qBAAU,WACR0E,EACEgB,YAAe,CACbF,IAAK9D,EAAMhB,KACXiF,MAAO,CACL3E,UAAU,eACLU,SAKV,CAACA,IAuCF,sBAAK9B,UAAU,YAAf,UACE,sBAAKA,UAAU,kBAAf,UACE,8CACA,kHAEF,cAAC,IAAD,CAAMiG,iBAAiB,SAASjG,UAAU,kBAA1C,SACG0E,EAAcwB,KAAI,SAACP,GAClB,OACE,cAACtB,EAAD,CAAS8B,IAAKR,EAAK7E,KAAnB,SACE,cAAC,EAAD,2BAAc6E,GAAd,IAAoB7E,KAAM6E,EAAKC,IAAK3E,UAAWA,EAAWC,UAAWA,EAAWC,cAAeA,MADnEwE,EAAKC","file":"static/js/8.3fd6efc2.chunk.js","sourcesContent":["import \"./index.scss\";\nimport MonacoEditor, { monaco } from \"react-monaco-editor\";\nimport PropTypes from \"prop-types\";\nimport { memo, useEffect, useRef } from \"react\";\n\nfunction Editor({ content, startLine, endLine }) {\n  const options = {\n    readOnly: true,\n  };\n  const editor = useRef(null);\n\n  function decorateAndScroll(editor) {\n    if (!editor || typeof startLine !== \"number\" || typeof endLine !== \"number\") {\n      return;\n    }\n    if (startLine > endLine) {\n      return;\n    }\n    setTimeout(() => { // 解决嵌入 弹框 中设置样式失效问题\n      editor.deltaDecorations(\n        [],\n        [\n          {\n            range: new monaco.Range(startLine, 1, endLine, 1), // 开始行，开始列，结束行，结束列\n            options: {\n              isWholeLine: true,\n              className: \"editor--hightlight\",\n            },\n          }\n        ]\n      );\n      editor.revealLineInCenter(Math.ceil((startLine + endLine) / 2));\n    }, 300);\n  }\n\n  useEffect(() => {\n    decorateAndScroll(editor.current);\n  }, [content, startLine, endLine]);\n\n  return (\n    <div className=\"editor\">\n      <MonacoEditor\n        language=\"javascript\"\n        theme=\"vs\"\n        value={content}\n        options={options}\n        editorDidMount={(e) => {\n          editor.current = e;\n          decorateAndScroll(editor.current);\n        }}\n      />\n    </div>\n  );\n}\n\nEditor.propTypes = {\n  content: PropTypes.string,\n  startLine: PropTypes.number,\n  endLine: PropTypes.number,\n};\n\nexport default memo(Editor);\n","import \"./index.scss\";\nimport PropTypes from \"prop-types\";\nimport { memo, useState } from \"react\";\nimport { Form, Button, Input, message } from \"antd\";\nimport Editor from \"../Editor\";\n\nfunction ErrorTab({ name, desc, code, startLine, endLine, onTrigger, onAnalyze, onInputChange, errorInfo, errorResult }) {\n  const [index, setIndex] = useState(1);\n\n\n  function _onTrigger() {\n    typeof onTrigger === \"function\" && onTrigger(name);\n  }\n  function _onAnalyze() {\n    typeof onAnalyze === \"function\" && onAnalyze(name);\n  }\n  function _onInputChange(e) {\n    const { id, value } = e.target;\n    typeof onInputChange === \"function\" &&\n      onInputChange(name, {\n        [id]: value,\n      });\n  }\n  function _onCalculate(next) {\n    if (!errorInfo?.error) {\n      return message.warning(\"请先触发错误.\");\n    }\n    const lines = errorInfo?.error.split(\"\\n\");\n    const line = lines[index];\n    // 正则参考: https://github.com/getsentry/sentry-javascript/blob/45508c08d30a0d959c60e1449605350d782ecc47/packages/browser/src/tracekit.ts\n    const chrome = /^\\s*at (?:(.*?) ?\\()?((?:file|https?|blob|chrome-extension|address|native|eval|webpack|<anonymous>|[-a-z]+:|.*bundle|\\/).*?)(?::(\\d+))?(?::(\\d+))?\\)?\\s*$/i;\n    const path = chrome.exec(line);\n    const [, , url, lineNo, columnNo] = path; \n    _onInputChange({\n      target: {\n        id: \"url\",\n        value: url,\n      },\n    });\n    _onInputChange({\n      target: {\n        id: \"lineNo\",\n        value: lineNo,\n      },\n    });\n    _onInputChange({\n      target: {\n        id: \"columnNo\",\n        value: columnNo,\n      },\n    });\n    if (next && index >= lines.length - 1) {\n      return message.warning(\"已是最后一个错误.\");\n    } else if(!next && index <= 1) {\n      return message.warning(\"已是第一个错误.\");\n    }\n    setIndex(next ? index + 1 : index - 1);\n  }\n\n  return (\n    <div className=\"errortab\">\n      <Form layout=\"vertical\">\n        <Form.Item label=\"用例说明\">{desc}</Form.Item>\n        <Form.Item label=\"代码示例\">\n          <div className=\"errortab__code\">\n            <Editor key=\"result\" content={code} startLine={startLine} endLine={endLine} />\n          </div>\n        </Form.Item>\n      </Form>\n\n      <div className=\"errortab__info\">\n        <div className=\"errortab__info__left\">\n          <div className=\"errortab__info__btn\">\n            <Button type=\"primary\" onClick={_onTrigger}>\n              触发错误\n            </Button>\n            <Button type=\"primary\" onClick={_onCalculate.bind(null, false)}>\n              定位上一个错误文件\n            </Button>\n            <Button type=\"primary\" onClick={_onCalculate.bind(null, true)}>\n              定位下一个错误文件\n            </Button>\n          </div>\n          <div className=\"errortab__info__btn\">\n            当前错误索引: {index}\n          </div>\n          <Form>\n            <Form.Item label=\"错误信息\">\n              <Input value={errorInfo.msg} disabled />\n            </Form.Item>\n            <Form.Item label=\"错误行数\">\n              <Input value={errorInfo.lineNo} onChange={_onInputChange} id=\"lineNo\" disabled />\n            </Form.Item>\n            <Form.Item label=\"错误列数\">\n              <Input value={errorInfo.columnNo} onChange={_onInputChange} id=\"columnNo\" disabled />\n            </Form.Item>\n            <Form.Item label=\"错误文件\">\n              <Input value={errorInfo.url} onChange={_onInputChange} id=\"url\" disabled />\n            </Form.Item>\n            <Form.Item label=\"错误堆栈\">\n              <Input.TextArea value={errorInfo.error} rows={12} disabled />\n            </Form.Item>\n          </Form>\n        </div>\n        <div className=\"errortab__info__right\">\n          <div className=\"errortab__info__btn\">\n            <Button type=\"primary\" onClick={_onAnalyze}>\n              解析 sourcemap\n            </Button>\n          </div>\n\n          <div className=\"errortab__info__edtior\">\n            <Editor key=\"result\" content={errorResult.content} startLine={errorResult.line} endLine={errorResult.line} />\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nErrorTab.propTypes = {\n  name: PropTypes.string,\n  desc: PropTypes.string,\n  code: PropTypes.string,\n  startLine: PropTypes.number,\n  endLine: PropTypes.number,\n  onTrigger: PropTypes.func,\n  onAnalyze: PropTypes.func,\n  onInputChange: PropTypes.func,\n  errorInfo: PropTypes.object,\n  errorResult: PropTypes.object,\n};\n\nexport default memo(ErrorTab);\n","import { getFileContentFromUrl } from \"@/util\";\n\nasync function analyzeSourcemap(error) {\n  const mapContent = await getFileContentFromUrl(`${error.url}.map`);\n  return new Promise((res) => {\n    sourceMap.SourceMapConsumer.with(mapContent, null, (consumer) => {\n      const position = consumer.originalPositionFor({\n        line: Number(error.lineNo),\n        column: Number(error.columnNo),\n      });\n      const content = consumer.sourceContentFor(position.source);\n      res({\n        content,\n        ...position,\n      });\n    });\n  });\n}\n\nexport {\n  analyzeSourcemap\n};","import \"./index.scss\";\nimport { Tabs } from \"antd\";\nimport ErrorTab from \"./component/ErrorTab\";\nimport useErrorListener from \"./hook/useErrorListener\";\nimport { useSelector, useDispatch } from \"react-redux\";\nimport { editConfigList, editConfigListErrorInfo } from \"./meta/sourcemapReducer\";\nimport { useEffect } from \"react\";\nimport { analyzeSourcemap } from \"./util\";\n\nconst { TabPane } = Tabs;\n\nfunction Sourcemap() {\n  console.log(\"render sourcemap\");\n  const tabConfigList = useSelector((state) => {\n    return state.sourcemap.tabConfigList;\n  });\n  const dispatch = useDispatch();\n  const { error } = useErrorListener();\n  useEffect(() => {\n    dispatch(\n      editConfigList({\n        key: error.name,\n        props: {\n          errorInfo: {\n            ...error,\n          },\n        },\n      })\n    );\n  }, [error]);\n\n  function onTrigger(name) {\n    if (name === \"test_1\") {\n      throw new Error(\"test_1\");\n    } else if (name === \"test_2\") {\n      new Promise(() => {\n        throw new Error(\"test_2\");\n      });\n    }\n  }\n\n  async function onAnalyze(name) {\n    const tabConfig = tabConfigList.find((item) => {\n      return item.key === name;\n    });\n    const result = await analyzeSourcemap(tabConfig.errorInfo);\n    dispatch(\n      editConfigList({\n        key: name,\n        props: {\n          errorResult: {\n            ...result,\n          },\n        },\n      })\n    );\n  }\n\n  function onInputChange(name, props) {\n    dispatch(\n      editConfigListErrorInfo({\n        key: error.name,\n        props,\n      })\n    );\n  }\n\n  return (\n    <div className=\"sourcemap\">\n      <div className=\"sourcemap__desc\">\n        <h1>说明</h1>\n        <p>此页面仅用于测试 source map 功能。</p>\n      </div>\n      <Tabs defaultActiveKey=\"test_1\" className=\"sourcemap__test\">\n        {tabConfigList.map((item) => {\n          return (\n            <TabPane tab={item.name} key={item.key}>\n              <ErrorTab {...item} name={item.key} onTrigger={onTrigger} onAnalyze={onAnalyze} onInputChange={onInputChange} />\n            </TabPane>\n          );\n        })}\n      </Tabs>\n    </div>\n  );\n}\n\nexport default Sourcemap;\n","/* eslint-disable no-debugger */\nimport { useEffect, useState } from \"react\";\n\nexport default function () {\n  const [error, setError] = useState({});\n  useEffect(() => {\n    window.onerror = function (msg, url, lineNo, columnNo, err) {\n      setError({\n        msg,\n        url,\n        lineNo,\n        columnNo,\n        error: err.stack,\n        name: err.message,\n      });\n      return false; // 返回 true，阻止默认行为，如在 console 中打印错误\n    };\n    window.onunhandledrejection = function(e) {\n      const reason = e.reason;\n      setError({\n        msg: reason.message,\n        url: \"\",\n        lineNo: \"\",\n        error: reason.stack,\n        name: reason.message,\n      });\n    };\n  }, []);\n  return {\n    error,\n  };\n}"],"sourceRoot":""}